<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ãƒ³ã‚¯ãƒ©ãƒ– ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            color: #666;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        
        .mode-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .test-mode-indicator {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }
        
        .sync-status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .sync-status.disconnected {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        .staff-info {
            background: #f0f7ff;
            border: 1px solid #2196f3;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .date-group {
            margin-bottom: 15px;
        }
        
        .date-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .date-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .current-event {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .current-event h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-mode-switch {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
            display: none;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .stats {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-weight: 500;
            color: #555;
        }
        
        .stats-value {
            font-weight: 600;
            color: #333;
        }
        
        .qr-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        #qrReader {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
        }
        
        #qrReader video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .barcode-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 100px;
            border: 2px solid #fff;
            border-radius: 8px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
        }
        
        .barcode-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #ff0000;
            animation: scan 2s ease-in-out infinite;
        }
        
        @keyframes scan {
            0%, 100% { top: 10%; }
            50% { top: 90%; }
        }
        
        .history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .member-id {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .clear-btn {
            background: #dc3545;
            font-size: 14px;
            padding: 12px 20px;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .export-btn {
            background: #28a745;
            font-size: 14px;
            padding: 12px 20px;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .active-staff {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .staff-badge {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .staff-badge.offline {
            background: #ccc;
        }
        
        .sync-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .sync-btn {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .sync-btn.refresh {
            background: #28a745;
            color: white;
        }
        
        .sync-btn.status {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ« ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒç®¡ç†</h1>
        
        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="sync-status" id="syncStatus">
            ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ: æ¥ç¶šä¸­
        </div>
        
        <!-- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ± -->
        <div class="staff-info">
            <strong>ã‚¹ã‚¿ãƒƒãƒ•: <span id="staffName">ã‚¹ã‚¿ãƒƒãƒ•001</span></strong>
            <div>æœ€çµ‚æ´»å‹•: <span id="lastActivity">--:--</span></div>
        </div>
        
        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="tabs">
            <button class="tab active">é…å¸ƒç®¡ç†</button>
            <button class="tab">é…å¸ƒå±¥æ­´</button>
            <button class="tab">åŒæœŸç®¡ç†</button>
            <button class="tab">è¨­å®š</button>
        </div>
        
        <!-- é…å¸ƒç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-content active" id="distribution">
            <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆæ‰‹å‹•å…¥åŠ›ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šï¼‰ -->
            <div class="input-mode-switch">
                <button type="button" class="mode-btn active" id="manualBtn">æ‰‹å‹•å…¥åŠ›</button>
                <button type="button" class="mode-btn" id="barcodeBtn">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            <div class="warning" id="warningMessage"></div>
            
            <form id="memberForm">
                <div class="form-group" id="manualInput">
                    <label for="memberId">ä¼šå“¡ç•ªå·</label>
                    <input type="text" id="memberId" name="memberId" placeholder="ä¼šå“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
                </div>
                
                <div class="form-group" id="barcodeInput" style="display: none;">
                    <label>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</label>
                    <div id="barcodeReader" style="width: 100%; max-width: 400px; margin: 0 auto; position: relative;">
                        <div class="barcode-overlay" id="barcodeOverlay" style="display: none;"></div>
                    </div>
                    <div id="barcodeStatus" class="qr-status">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
                    <button type="button" class="btn" id="startBarcodeBtn">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
                    <button type="button" class="btn" id="stopBarcodeBtn" style="display: none;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
                </div>
                
                <button type="submit" class="btn">ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒ</button>
            </form>
            
            <!-- ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± -->
            <div class="current-event" id="currentEvent">
                <h3>ğŸ“… ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
                <div id="eventInfo">è¨­å®šã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
            </div>
            
            <div class="stats">
                <div class="stats-row">
                    <span class="stats-label">æœ¬æ—¥ã®é…å¸ƒæ¸ˆã¿æšæ•°ï¼š</span>
                    <span class="stats-value" id="todayCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">ç·é…å¸ƒæ¸ˆã¿æšæ•°ï¼š</span>
                    <span class="stats-value" id="totalCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">å…¨ã‚¹ã‚¿ãƒƒãƒ•ç·è¨ˆï¼š</span>
                    <span class="stats-value" id="globalTotalCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">æœ€å¾Œã®é…å¸ƒæ™‚åˆ»ï¼š</span>
                    <span class="stats-value" id="lastTime">æœªé…å¸ƒ</span>
                </div>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
            <div class="mode-selector">
                <button class="mode-btn active" id="productionBtn">æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰</button>
                <button class="mode-btn" id="testBtn">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            
            <!-- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div class="test-mode-indicator" id="testModeIndicator">
                ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã—ã¾ã›ã‚“
            </div>
        </div>
        
        <!-- é…å¸ƒå±¥æ­´ã‚¿ãƒ– -->
        <div class="tab-content" id="history">
            <div class="form-group">
                <label>é…å¸ƒå±¥æ­´</label>
                <div class="history" id="historyContainer">
                    <div style="text-align: center; color: #666; font-style: italic;">
                        ã¾ã é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" class="btn clear-btn" onclick="clearHistory()" style="width: auto; flex: 1;">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
                    <button type="button" class="btn export-btn" onclick="exportCSV()" style="width: auto; flex: 1;">CSVå‡ºåŠ›</button>
                    <button type="button" class="btn export-btn" onclick="exportText()" style="width: auto; flex: 1;">ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
                </div>
            </div>
            
            <div class="export-section">
                <div class="export-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</div>
                <div class="export-options">
                    <button type="button" class="btn export-btn" onclick="exportDetailedCSV()">è©³ç´°CSVå‡ºåŠ›</button>
                    <button type="button" class="btn export-btn" onclick="exportMemberListOnly()">ä¼šå“¡ç•ªå·ã®ã¿å‡ºåŠ›</button>
                    <button type="button" class="btn export-btn" onclick="copyToClipboard()">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
        </div>
        
        <!-- åŒæœŸç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-content" id="sync">
            <div class="active-staff">
                <h3>ğŸ‘¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ãƒƒãƒ•</h3>
                <div class="staff-list" id="staffList">
                    <div class="staff-badge">ã‚¹ã‚¿ãƒƒãƒ•001 (è‡ªåˆ†)</div>
                    <div class="staff-badge offline">ã‚¹ã‚¿ãƒƒãƒ•002</div>
                    <div class="staff-badge offline">ã‚¹ã‚¿ãƒƒãƒ•003</div>
                </div>
            </div>
            
            <div class="sync-controls">
                <button class="sync-btn refresh" onclick="forceSyncData()">ãƒ‡ãƒ¼ã‚¿åŒæœŸ</button>
                <button class="sync-btn status" onclick="checkSyncStatus()">æ¥ç¶šç¢ºèª</button>
            </div>
            
            <div class="stats">
                <div class="stats-row">
                    <span class="stats-label">åŒæœŸæ¸ˆã¿ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼š</span>
                    <span class="stats-value" id="syncedRecords">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">æœ€çµ‚åŒæœŸæ™‚åˆ»ï¼š</span>
                    <span class="stats-value" id="lastSyncTime">æœªåŒæœŸ</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">åŒæœŸå¾…ã¡ãƒ‡ãƒ¼ã‚¿ï¼š</span>
                    <span class="stats-value" id="pendingSync">0</span>
                </div>
            </div>
            
            <div class="date-settings">
                <h3>ğŸ”§ åŒæœŸè¨­å®š</h3>
                
                <div class="date-group">
                    <label for="staffName">ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <input type="text" id="staffNameInput" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ">
                </div>
                
                <div class="date-group">
                    <label for="syncInterval">åŒæœŸé–“éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="syncInterval" value="10" min="5" max="60">
                </div>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="autoSync" checked> 
                        è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    </label>
                </div>
                
                <button type="button" class="btn" onclick="saveSyncSettings()">åŒæœŸè¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
        
        <!-- è¨­å®šã‚¿ãƒ– -->
        <div class="tab-content" id="settings">
            <div class="date-settings">
                <h3>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h3>
                
                <div class="date-group">
                    <label for="eventName">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                    <input type="text" id="eventName" placeholder="ä¾‹ï¼š2025å¹´æ˜¥ãƒ©ã‚¤ãƒ–">
                </div>
                
                <div class="date-group">
                    <label for="eventDate">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»˜</label>
                    <input type="date" id="eventDate">
                </div>
                
                <div class="date-group">
                    <label for="eventVenue">ä¼šå ´å</label>
                    <input type="text" id="eventVenue" placeholder="ä¾‹ï¼šæ±äº¬ãƒ‰ãƒ¼ãƒ ">
                </div>
                
                <button type="button" class="btn" onclick="saveEventSettings()">è¨­å®šã‚’ä¿å­˜</button>
            </div>
            
            <div class="date-settings">
                <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="strictDateCheck"> 
                        å³å¯†ãªæ—¥ä»˜ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»¥å¤–ã¯é…å¸ƒã‚’åˆ¶é™ï¼‰
                    </label>
                </div>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="allowDuplicateInTest"> 
                        ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é‡è¤‡ã‚’è¨±å¯
                    </label>
                </div>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="soundNotification" checked> 
                        éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    </label>
                </div>
                
                <button type="button" class="btn" onclick="saveSystemSettings()">è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let distributedMembers = [];
        let testDistributedMembers = [];
        let globalDistributedMembers = []; // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®é…å¸ƒè¨˜éŒ²
        let html5QrCode = null;
        let isBarcodeMode = false;
        let isTestMode = false;
        let staffId = 'staff001';
        let staffName = 'ã‚¹ã‚¿ãƒƒãƒ•001';
        let syncInterval = 10000; // 10ç§’
        let autoSyncEnabled = true;
        let syncTimer = null;
        let isConnected = false;
        let lastScanTime = 0; // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã®é€£ç¶šå®Ÿè¡Œé˜²æ­¢
        
        let eventSettings = {
            name: '',
            date: '',
            venue: ''
        };
        let systemSettings = {
            strictDateCheck: false,
            allowDuplicateInTest: false,
            soundNotification: true
        };
        
        // DOMè¦ç´ 
        const form = document.getElementById('memberForm');
        const memberIdInput = document.getElementById('memberId');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const warningMessage = document.getElementById('warningMessage');
        const todayCount = document.getElementById('todayCount');
        const totalCount = document.getElementById('totalCount');
        const globalTotalCount = document.getElementById('globalTotalCount');
        const lastTime = document.getElementById('lastTime');
        const manualInput = document.getElementById('manualInput');
        const barcodeInput = document.getElementById('barcodeInput');
        const barcodeStatus = document.getElementById('barcodeStatus');
        const startBarcodeBtn = document.getElementById('startBarcodeBtn');
        const stopBarcodeBtn = document.getElementById('stopBarcodeBtn');
        const manualBtn = document.getElementById('manualBtn');
        const barcodeBtn = document.getElementById('barcodeBtn');
        const testModeIndicator = document.getElementById('testModeIndicator');
        const productionBtn = document.getElementById('productionBtn');
        const testBtn = document.getElementById('testBtn');
        const currentEvent = document.getElementById('currentEvent');
        const eventInfo = document.getElementById('eventInfo');
        const syncStatus = document.getElementById('syncStatus');
        const staffNameDisplay = document.getElementById('staffName');
        const lastActivity = document.getElementById('lastActivity');
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateEventDisplay();
            updateStats();
            updateStaffInfo();
            memberIdInput.focus();
            initializeSync();
            setupEventListeners();
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupEventListeners() {
            // ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.addEventListener('click', function() {
                    const tabNames = ['distribution', 'history', 'sync', 'settings'];
                    showTab(tabNames[index]);
                });
            });
            
            // æœ¬ç•ª/ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            const productionBtn = document.getElementById('productionBtn');
            const testBtn = document.getElementById('testBtn');
            if (productionBtn) productionBtn.addEventListener('click', switchToProduction);
            if (testBtn) testBtn.addEventListener('click', switchToTest);
            
            // æ‰‹å‹•/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            const manualBtn = document.getElementById('manualBtn');
            const barcodeBtn = document.getElementById('barcodeBtn');
            if (manualBtn) manualBtn.addEventListener('click', switchToManual);
            if (barcodeBtn) barcodeBtn.addEventListener('click', switchToBarcode);
            
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³
            const startBarcodeBtn = document.getElementById('startBarcodeBtn');
            const stopBarcodeBtn = document.getElementById('stopBarcodeBtn');
            if (startBarcodeBtn) startBarcodeBtn.addEventListener('click', startBarcodeScanner);
            if (stopBarcodeBtn) stopBarcodeBtn.addEventListener('click', stopBarcodeScanner);
            
            // è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå¾Œã§è¿½åŠ ï¼‰
            setupSettingsButtons();
        }
        
        // è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        function setupSettingsButtons() {
            // å°‘ã—é…ã‚Œã¦è¨­å®šãƒœã‚¿ãƒ³ã‚’æ¤œç´¢ï¼ˆDOMæ§‹ç¯‰å®Œäº†å¾Œï¼‰
            setTimeout(() => {
                const saveEventBtn = document.querySelector('button[onclick="saveEventSettings()"]');
                const saveSystemBtn = document.querySelector('button[onclick="saveSystemSettings()"]');
                const saveSyncBtn = document.querySelector('button[onclick="saveSyncSettings()"]');
                const clearBtn = document.querySelector('button[onclick="clearHistory()"]');
                const exportCSVBtn = document.querySelector('button[onclick="exportCSV()"]');
                const exportTextBtn = document.querySelector('button[onclick="exportText()"]');
                
                if (saveEventBtn) {
                    saveEventBtn.removeAttribute('onclick');
                    saveEventBtn.addEventListener('click', saveEventSettings);
                }
                if (saveSystemBtn) {
                    saveSystemBtn.removeAttribute('onclick');
                    saveSystemBtn.addEventListener('click', saveSystemSettings);
                }
                if (saveSyncBtn) {
                    saveSyncBtn.removeAttribute('onclick');
                    saveSyncBtn.addEventListener('click', saveSyncSettings);
                }
                if (clearBtn) {
                    clearBtn.removeAttribute('onclick');
                    clearBtn.addEventListener('click', clearHistory);
                }
                if (exportCSVBtn) {
                    exportCSVBtn.removeAttribute('onclick');
                    exportCSVBtn.addEventListener('click', exportCSV);
                }
                if (exportTextBtn) {
                    exportTextBtn.removeAttribute('onclick');
                    exportTextBtn.addEventListener('click', exportText);
                }
            }, 100);
        }
        
        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            const savedEventSettings = localStorage.getItem('eventSettings');
            const savedSystemSettings = localStorage.getItem('systemSettings');
            const savedDistributedMembers = localStorage.getItem('distributedMembers');
            const savedTestDistributedMembers = localStorage.getItem('testDistributedMembers');
            const savedStaffInfo = localStorage.getItem('staffInfo');
            
            if (savedEventSettings) {
                eventSettings = JSON.parse(savedEventSettings);
                document.getElementById('eventName').value = eventSettings.name || '';
                document.getElementById('eventDate').value = eventSettings.date || '';
                document.getElementById('eventVenue').value = eventSettings.venue || '';
            }
            
            if (savedSystemSettings) {
                systemSettings = JSON.parse(savedSystemSettings);
                document.getElementById('strictDateCheck').checked = systemSettings.strictDateCheck || false;
                document.getElementById('allowDuplicateInTest').checked = systemSettings.allowDuplicateInTest || false;
                document.getElementById('soundNotification').checked = systemSettings.soundNotification !== false;
            }
            
            if (savedDistributedMembers) {
                distributedMembers = JSON.parse(savedDistributedMembers);
            }
            
            if (savedTestDistributedMembers) {
                testDistributedMembers = JSON.parse(savedTestDistributedMembers);
            }
            
            if (savedStaffInfo) {
                const staffInfo = JSON.parse(savedStaffInfo);
                staffId = staffInfo.id || 'staff001';
                staffName = staffInfo.name || 'ã‚¹ã‚¿ãƒƒãƒ•001';
                document.getElementById('staffNameInput').value = staffName;
            }
        }
        
        // åŒæœŸåˆæœŸåŒ–
        function initializeSync() {
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸæ¥ç¶šçŠ¶æ…‹
            isConnected = Math.random() > 0.3; // 70%ã®ç¢ºç‡ã§æ¥ç¶š
            updateSyncStatus();
            
            if (autoSyncEnabled) {
                startAutoSync();
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            generateMockGlobalData();
        }
        
        // æ¨¡æ“¬çš„ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateMockGlobalData() {
            const mockData = [];
            const today = getTodayString();
            const staffs = ['staff001', 'staff002', 'staff003'];
            
            for (let i = 0; i < 50; i++) {
                const staff = staffs[Math.floor(Math.random() * staffs.length)];
                const time = new Date();
                time.setHours(Math.floor(Math.random() * 8) + 10, Math.floor(Math.random() * 60));
                
                mockData.push({
                    id: `M${String(1000 + i).padStart(6, '0')}`,
                    timestamp: time.toLocaleString('ja-JP'),
                    date: today,
                    staffId: staff,
                    testMode: false
                });
            }
            
            globalDistributedMembers = mockData;
            localStorage.setItem('globalDistributedMembers', JSON.stringify(globalDistributedMembers));
        }
        
        // è‡ªå‹•åŒæœŸé–‹å§‹
        function startAutoSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
            }
            
            syncTimer = setInterval(() => {
                if (autoSyncEnabled) {
                    syncDataWithServer();
                }
            }, syncInterval);
        }
        
        // ã‚µãƒ¼ãƒãƒ¼ã¨ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸï¼ˆæ¨¡æ“¬ï¼‰
        function syncDataWithServer() {
            if (!isConnected) {
                updateSyncStatus();
                return;
            }
            
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼APIã‚’å‘¼ã³å‡ºã—
            // ä»Šå›ã¯æ¨¡æ“¬çš„ãªå‡¦ç†
            const currentTime = getCurrentTime();
            document.getElementById('lastSyncTime').textContent = currentTime;
            document.getElementById('syncedRecords').textContent = distributedMembers.length;
            document.getElementById('pendingSync').textContent = '0';
            
            updateStats();
        }
        
        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus() {
            if (isConnected) {
                syncStatus.textContent = 'ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ: æ¥ç¶šä¸­';
                syncStatus.className = 'sync-status';
            } else {
                syncStatus.textContent = 'âš ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ: æ¥ç¶šå¤±æ•—';
                syncStatus.className = 'sync-status disconnected';
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±æ›´æ–°
        function updateStaffInfo() {
            staffNameDisplay.textContent = staffName;
            lastActivity.textContent = getCurrentTime();
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const clickedTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å±¥æ­´ã‚’æ›´æ–°ï¼ˆå±¥æ­´ã‚¿ãƒ–ã®å ´åˆï¼‰
            if (tabName === 'history') {
                updateHistory();
            }
        }
        
        // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰/ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchToProduction() {
            isTestMode = false;
            productionBtn.classList.add('active');
            testBtn.classList.remove('active');
            testModeIndicator.style.display = 'none';
            updateStats();
        }
        
        function switchToTest() {
            isTestMode = true;
            productionBtn.classList.remove('active');
            testBtn.classList.add('active');
            testModeIndicator.style.display = 'block';
            updateStats();
        }
        
        // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        function switchToManual() {
            isQRMode = false;
            manualInput.style.display = 'block';
            qrInput.style.display = 'none';
            manualBtn.classList.add('active');
            qrBtn.classList.remove('active');
            
            if (html5QrCode && html5QrCode.isScanning) {
                stopQRScanner();
            }
            
            memberIdInput.focus();
            hideMessages();
        }
        
        // QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        function switchToQR() {
            isQRMode = true;
            manualInput.style.display = 'none';
            qrInput.style.display = 'block';
            manualBtn.classList.remove('active');
            qrBtn.classList.add('active');
            
            hideMessages();
        }
        
        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‹ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å¯¾å¿œï¼‰
        function startBarcodeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                stopBarcodeScanner();
                return;
            }
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("barcodeReader");
            }
            
            barcodeStatus.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
            startBarcodeBtn.style.display = 'none';
            stopBarcodeBtn.style.display = 'block';
            document.getElementById('barcodeOverlay').style.display = 'block';
            
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‹QRã‚³ãƒ¼ãƒ‰å¯¾å¿œã®è¨­å®š
            const scanConfig = {
                fps: 10,
                qrbox: { width: 300, height: 100 },
                aspectRatio: 3.0, // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”¨ã®æ¨ªé•·æ¯”ç‡
                disableFlip: false,
                supportedScanTypes: [
                    Html5QrcodeScanType.SCAN_TYPE_CAMERA,
                ],
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.CODE_93,
                    Html5QrcodeSupportedFormats.CODABAR,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E
                ]
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                scanConfig,
                (decodedText, decodedResult) => {
                    // é€£ç¶šèª­ã¿å–ã‚Šé˜²æ­¢ï¼ˆ1ç§’ä»¥å†…ã®é‡è¤‡ã‚’é˜²ãï¼‰
                    const currentTime = Date.now();
                    if (currentTime - lastScanTime < 1000) {
                        return;
                    }
                    lastScanTime = currentTime;
                    
                    // èª­ã¿å–ã‚Šå½¢å¼ã‚’åˆ¤å®š
                    const format = decodedResult.result.format;
                    let formatName = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰";
                    if (format && format.formatName) {
                        formatName = format.formatName === "QR_CODE" ? "QRã‚³ãƒ¼ãƒ‰" : "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰";
                    }
                    
                    barcodeStatus.textContent = `${formatName}èª­ã¿å–ã‚ŠæˆåŠŸ: ${decodedText}`;
                    
                    // éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    if (systemSettings.soundNotification) {
                        playSuccessSound();
                    }
                    
                    // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‡¦ç†
                    processMemberRegistration(decodedText);
                    
                    // æˆåŠŸå¾Œå°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®èª­ã¿å–ã‚Šã‚’å¯èƒ½ã«ã™ã‚‹
                    setTimeout(() => {
                        barcodeStatus.textContent = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„";
                    }, 2000);
                },
                (errorMessage) => {
                    // é€šå¸¸ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆé€£ç¶šçš„ã«ç™ºç”Ÿã™ã‚‹ãŸã‚ï¼‰
                }
            ).then(() => {
                barcodeStatus.textContent = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„";
            }).catch(err => {
                console.error("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
                barcodeStatus.textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚";
                startBarcodeBtn.style.display = 'block';
                stopBarcodeBtn.style.display = 'none';
                document.getElementById('barcodeOverlay').style.display = 'none';
                
                // iPhone Safariã®å ´åˆã®è¿½åŠ èª¬æ˜
                if (navigator.userAgent.includes('iPhone') && navigator.userAgent.includes('Safari')) {
                    barcodeStatus.textContent += " iPhone Safariã‚’ã”åˆ©ç”¨ã®å ´åˆã¯ã€è¨­å®šï¼Safariï¼ã‚«ãƒ¡ãƒ©ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
                }
            });
        }
        
        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢
        function stopBarcodeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    barcodeStatus.textContent = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ";
                    startBarcodeBtn.style.display = 'block';
                    stopBarcodeBtn.style.display = 'none';
                    document.getElementById('barcodeOverlay').style.display = 'none';
                }).catch(err => {
                    console.error("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
                });
            }
        }
        
        // æˆåŠŸéŸ³ã‚’å†ç”Ÿ
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log("éŸ³å£°å†ç”Ÿã«å¤±æ•—:", error);
            }
        }
            